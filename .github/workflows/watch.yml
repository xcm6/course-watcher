name: course-watcher

on:
  schedule:
    - cron: "*/5 * * * *"   # 每5分钟跑一次
  workflow_dispatch:         # 允许你手动点 Run workflow

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # 关键：用 cache 记住上一次 state.json，否则每次都像第一次运行，不会触发 no->yes
      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: state.json
          key: course-watcher-state

      - name: Run watcher
        env:
          WATCH_URL: ${{ secrets.WATCH_URL }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
        run: python watch.py

      - name: Save state cache
        uses: actions/cache@v4
        with:
          path: state.json
          key: course-watcher-state
